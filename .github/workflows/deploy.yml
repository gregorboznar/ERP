name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout new code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e
            cd /home/jost/web/vkp.glab.si/public_html

            echo "Running deploy as jost..."

            sudo -u jost bash -c '
              set -e

              git fetch origin
              git reset --hard origin/main

              composer install --no-dev --optimize-autoloader

              npm ci
              npm run build

              php artisan optimize:clear
              php artisan migrate --force
              php artisan optimize
            '

            echo "Fixing permissions..."
            chown -R jost:www-data storage bootstrap/cache
            chmod -R 775 storage bootstrap/cache

            echo "Deployment completed successfully!"
